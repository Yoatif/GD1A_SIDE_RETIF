<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>GD1A_SIDE_RETIF</title>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
        
        <style type="text/css"> body { margin: 0; }</style>
        
    </head>
    <body>
        <script>
            var config = {

            //le type, permet de définir la gestion du rendu. AUTO laisse le navigateur choisir. 
            type: Phaser.AUTO,

            //définie les dimmensions de la fenetre de jeu, 
            //la map peut faire la taille que vous souhaitez (bon y'a une limite mais je ne sais plus a combien elle est),
            width: 400,
            height: 200,


            physics: {
                
                default: 'arcade',
                arcade: {
                    //définie la gravité, son orientation et l'affichage du débug.
                    gravity: { y: 300 },
                    debug: true
                }
            },
            input:{gamepad:true},
            //définie l'ordre de lecture des scènes
            scene: {
                preload: preload,
                create: create,
                update: update
            }
            };

            //la variable game permet de lancé le jeu selon les paramètres de config
            var game = new Phaser.Game(config);

            //variable 
            let player;
            let playerLife = 1;
            let cursors;
            let controller = false;
            let walljump = true;
            let gameOver = false;
            let monster;
            let deathMonster;
            let spikes;
            let clef1 = false;
            let clef2 = false;
            let clef3 = false;
            let clef4 = false;
            let lock1 = false;
            let lock2 = false;
            let lock3 = false;
            let lock4 = false;
            let warp1;
            let warp2;
            let warp3;
            let warp4;
            let warp5;
            let warp6;
            let warp7;
            let warp8;
            let warp9;
            let warp10;
            let fly;
            let score=0;


            function preload(){

                //import background 
                this.load.image('bg',"assets/background_test.png");
                this.load.image('grotte', 'assets/grotte.png');

                //import spritesheet
                this.load.spritesheet('player','assets/spritesheet.png',{frameWidth: 512, frameHeight: 1024});

                //import tiled
                this.load.tilemapTiledJSON('temple','tiled/premierNiveau.json');
                this.load.image('tileset', 'assets/Tileset.png');

                //import collectible
                this.load.image('collect', 'assets/mouche.png');

                //import warp
                this.load.image('warp', 'assets/warp.png');

                //import enemy
                this.load.spritesheet('loutre','spritesheet_enemy.png',{frameWidth:186, frameHeight:448});

                //import spike "grotte"
                this.load.image('piquesSol', 'assets/piques_sol.png');
                this.load.image('piquesPlafond', 'assets/piques_plafond.png');
                this.load.image('piquesMurG', 'assets/piques_mur_G.png');
                this.load.image('piquesMurD', 'assets/piques_mur_D.png');

                //import spike "temple"
                this.load.image('piquesSolTemple', 'assets/piques_mur_sol_temple.png');
                this.load.image('piquesPlafondTemple', 'assets/piques_mur_ceilling_temple.png');
                this.load.image('piquesMurGTemple', 'assets/piques_mur_G_temple.png');
                this.load.image('piquesMurDTemple', 'assets/piques_mur_D_temple.png');

            }

            function create(){

                this.add.image(800,800,'bg');
                this.add.image(800,1456,'grotte');

                const map = this.add.tilemap("temple");

                const tileset = map.addTilesetImage(
                    "tileset",
                    "tileset"
                );

                const fond = map.createLayer(
                    "fond",
                    tileset
                );
                const sol = map.createLayer(
                    "sol",
                    tileset
                );
                const deco = map.createLayer(
                    "deco",
                    tileset
                );

                fly = this.physics.add.group({
                    immovable: true,
                    allowGravity: false
                });

                collectible = map.getObjectLayer('collectible');
                collectible.objects.forEach( collectible => {
                const collect_fly = fly.create( collectible.x, collectible.y, "collect").setScale(0.05)/*.setAllowGravity(false)*/;
                //collect_fly.setImmovable(true)
                collect_fly.body.setAllowGravity(false)
                //console.log(collect_fly.body)            
                    
                });
                //fly.setAllowGravity(false);

                //fly.body.gravity.y = 0;
                //fly.allowGravity = false;

                //importation calques piques grotte
                // piques grotte a droite
                piques_rightGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_right = map.getObjectLayer('spike_grotte_right');
                piques_right.objects.forEach(piques_right=> {
                const RPiques =  piques_rightGroup.create(piques_right.x,  piques_right.y, "piquesMurD").setScale(0.1); 
                RPiques.body.setImmovable(true)
                RPiques.body.setAllowGravity(false)
                });
                //piques grotte au plafond
                piques_ceillingGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_ceilling = map.getObjectLayer('spike_grotte_ceilling');
                piques_ceilling.objects.forEach(piques_ceilling=> {
                const CPiques =  piques_ceillingGroup.create(piques_ceilling.x,  piques_ceilling.y, "piquesPlafond").setScale(0.1); 
                
                CPiques.body.setAllowGravity(false)
                CPiques.body.setImmovable(true)
                });
                //piques grotte au sol
                piques_floorGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_floor = map.getObjectLayer('spike_grotte_sol');
                piques_floor.objects.forEach(piques_floor=> {
                const SPiques =  piques_floorGroup.create(piques_floor.x,  piques_floor.y, "piquesSol").setScale(0.1); 
                SPiques.body.setImmovable(true)
                SPiques.body.setAllowGravity(false)
                });

                piques_leftGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_left = map.getObjectLayer('spike_grotte_left');
                piques_left.objects.forEach(piques_left=> {
                const LPiques =  piques_leftGroup.create(piques_left.x,  piques_left.y, "piquesMurG").setScale(0.1); 
                LPiques.body.setImmovable(true)
                LPiques.body.setAllowGravity(false)
                });

                // importation calques piques temple

                piques_temple_leftGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_temple_left = map.getObjectLayer('left_spike');
                piques_temple_left.objects.forEach(piques_temple_left=> {
                const LTPiques =  piques_temple_leftGroup.create(piques_temple_left.x,  piques_temple_left.y, "piquesMurGTemple").setScale(0.1); 
                LTPiques.body.setImmovable(true)
                LTPiques.body.setAllowGravity(false)
                });
                
                piques_temple_rightGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_temple_right = map.getObjectLayer('right_spike');
                piques_temple_right.objects.forEach(piques_temple_right=> {
                const RTPiques =  piques_temple_rightGroup.create(piques_temple_right.x,  piques_temple_right.y, "piquesMurDTemple").setScale(0.1); 
                
                RTPiques.body.setAllowGravity(false)
                });

                piques_temple_ceillingGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });
                piques_temple_ceilling = map.getObjectLayer('ceilling_spike');
                piques_temple_ceilling.objects.forEach(piques_temple_ceilling=> {
                const CTPiques =  piques_temple_ceillingGroup.create(piques_temple_ceilling.x,  piques_temple_ceilling.y, "piquesPlafondTemple").setScale(0.1); 
                CTPiques.body.setImmovable(true)
                CTPiques.body.setAllowGravity(false)
                });

                piques_temple_floorGroup = this.physics.add.group({
                    AllowGravity: false,
                    Immovable: true
                });

                piques_temple_floor = map.getObjectLayer('floor_spike');
                piques_temple_floor.objects.forEach(piques_temple_floor=> {
                const FTPiques =  piques_temple_floorGroup.create(piques_temple_floor.x,  piques_temple_floor.y, "piquesSolTemple").setScale(0.1); 
                FTPiques.body.setImmovable(true)
                FTPiques.body.setAllowGravity(false)
                });

                

                
                

                sol.setCollisionByProperty({collider: true});

                // player and animation creation
                player = this.physics.add.sprite(48,1500,'player').setScale(0.05);
                player.setCollideWorldBounds(true);
                this.physics.add.collider(player,sol);

                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('player', {start:1,end:7}),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'turn',
                    frames: [ { key: 'player', frame: 0 } ],
                    frameRate: 20
                });

                // Redimension du Monde
                this.physics.world.setBounds(0, 0, 1600, 1600);
                //  Creation de la Camera
                this.cameras.main.setBounds(0, 0, 1600, 1600);
                // Ancrage de la Camera
                this.cameras.main.startFollow(player);  

                //set overlap with fly
                this.physics.add.overlap(player, fly, collectFly, null, this);

                //creating collider with the different spikes layer
                this.physics.add.collider(player, piques_ceillingGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_floorGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_leftGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_rightGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_temple_ceillingGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_temple_floorGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_temple_leftGroup, isSpiked, null, this);
                this.physics.add.collider(player, piques_temple_rightGroup, isSpiked, null, this);
                

                
                //get score
                scoreText = this.add.text(16,16, 'score: 0', {fontSize: '32px', fill:'#000'}).setScrollFactor(0).setScale(0.5);
                //scoreText.fixedToCamera = true;

                //keyboard control
                cursors = this.input.keyboard.createCursorKeys();
                
                //gamepad creation
            }

            function update(){

                if(cursors.left.isDown){
                    player.anims.play('left', true);
                    player.setVelocityX(-300);
                    player.setFlipX(true);
                }else if(cursors.right.isDown){
                    player.setVelocityX(300);
                    player.anims.play('left', true);
                    player.setFlipX(false);
                }else{
                    player.anims.play('turn', true);
                    player.setVelocityX(0);
                }
                
                if(cursors.up.isDown && player.body.blocked.down){
                    player.setVelocityY(-200);
                }
                //Wall Jump
                if (cursors.up.isDown && player.body.blocked.right || controller.up && player.body.blocked.right) {
                    if (walljump == true) {
                        //walljump = false;
                        //  offTouche = true;
                        //setTimeout(cdWallJump, 500);
                        //setTimeout(blocageTouche, 200);
                        player.setVelocityY(-200);
                        player.setVelocityX(-450);
                        //setTimeout(cdDJ, 500);
                    }
                }

                if (cursors.up.isDown && player.body.blocked.left || controller.up && player.body.blocked.left) {
                    if (walljump == true) {
                        //walljump = false;
                        //offTouche = true;
                        //setTimeout(cdWallJump, 500);
                        //setTimeout(blocageTouche, 200);
                        player.setVelocityY(-200);
                        player.setVelocityX(450);
                        //setTimeout(cdDJ, 500);
                    }
                }

                this.input.gamepad.once('connected', function (pad) {
                    controller = pad;
                });

                scoreText.x = this.cameras.main.x;
                scoreText.y = this.cameras.main.y; 



                

            }
            
            function collectFly(player, fly){
                fly.disableBody(true,true);
                score += 10;
                scoreText.setText('score: '+score);
                
            }

            function isSpiked(player){
                player.disableBody(true,true);    
                console.log("is spiked");
                score=0;
                this.scene.restart();
                //this.scene.restart()
            }

            
            function death(player) {
                console.log("RIP");
                this.physics.pause();
                player.setTint(0xff0000);
                player.anims.play('turn');
                player.gravity(false)
            }
        </script>
    </body>